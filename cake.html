<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC_S1tr4bL7oJE4q_erTVzYZ6MIsBQDF1Y",
    authDomain: "dessert-515c4.firebaseapp.com",
    projectId: "dessert-515c4",
    storageBucket: "dessert-515c4.appspot.com",
    messagingSenderId: "710755169317",
    appId: "1:710755169317:web:e02723370229034f4dfbcc",
    measurementId: "G-YBCB593TBX"
  };

  // 初始化 Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  new Vue({
    el: '#app',
    data: {
      date: '',
      name: '',
      weight: 0,
      amount: 0,
      pricePerGram: null,
      history: []
    },
    methods: {
      calculate() {
        if (this.weight > 0 && this.amount > 0) {
          this.pricePerGram = (this.amount / this.weight).toFixed(2);
        } else {
          alert('請確認輸入的數據正確');
        }
      },
      async saveData() {
        if (this.date && this.name && this.pricePerGram !== null) {
          const newEntry = {
            date: this.date,
            name: this.name,
            weight: this.weight,
            amount: this.amount,
            pricePerGram: this.pricePerGram,
            timestamp: new Date()
          };

          try {
            // 儲存到 Firebase Firestore
            const docRef = await addDoc(collection(db, "materials"), newEntry);
            console.log("Document written with ID: ", docRef.id);
            this.history.push(newEntry);
          } catch (error) {
            console.error("Error adding document: ", error);
          }
        } else {
          alert('請先計算價格再儲存');
        }
      },
      async fetchHistory() {
        this.history = []; // 清空本地資料
        const querySnapshot = await getDocs(collection(db, "materials"));
        querySnapshot.forEach((doc) => {
          this.history.push(doc.data());
        });
      }
    },
    mounted() {
      this.fetchHistory(); // 載入 Firebase 中的歷史紀錄
    }
  });
</script>
